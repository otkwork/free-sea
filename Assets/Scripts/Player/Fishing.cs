using System.Linq.Expressions;
using System.Security.Cryptography;
using UnityEditor.PackageManager;
using UnityEditor.ShaderKeywordFilter;
using UnityEngine;
using UnityEngine.InputSystem;

public class Fishing : MonoBehaviour
{
	[SerializeField] Transform playerHead;
	[SerializeField] GameObject rodFloat;
	[SerializeField] Animator rodAnime;
	[SerializeField] GameObject fishingRod;
	FishingRod rod;
	PlayerController playerController;

	static readonly Vector3 FloatOffset = new Vector3(0, 5, 0); // 浮きを投げるときのオフセット
	readonly float[] reelSpeed =
	{
		1.5f,
		1.0f,
		0.5f
	};

	float rotationY;
	float rotationX;
	bool isHit;

	// リールの回転を取得するための変数
	float lastAngle = 0f;
	bool wasActive = false;

	private void Awake()
	{
		rod = rodFloat.GetComponent<FishingRod>();
		playerController = GetComponent<PlayerController>();
		isHit = false;
	}

	void Update()
	{
		if (Cursor.visible) return; // カーソルが表示されている場合は何もしない(Pause)

		if (InputSystem.Fishing())
		{
			// 釣り中じゃない場合浮きを飛ばす
			if (!rod.CanThrow())
			{
				// 釣り開始
				rodAnime.SetTrigger("Throw");
				rodFloat.transform.position = playerHead.position + FloatOffset + transform.forward * -3;
				rodFloat.SetActive(true);
				rod.FishingStart(playerHead.forward);
			}
			// 投げている最中じゃなく魚がかかっていないなら浮きを回収する
			else if(rod.IsFishing() && !isHit)
			{
				rod.FishingEnd(false);
			}
		}

		
		// 魚がかかった時用の機構
        if (isHit)
        {
			// 画面を固定して竿だけ動かせるようにする
			MouseRod();

            // リールを巻く
            Reel();
        }
	}

	private void MouseRod()
	{
        Vector2 mouseInput = InputSystem.CameraGetAxis();

        rotationX += mouseInput.y;
        rotationY -= mouseInput.x;
        rotationX += 0.5f;
        rotationX = Mathf.Clamp(rotationX, -30, 30);
        rotationY = Mathf.Clamp(rotationY, -30, 30);

        // 頭、体の向きの適用
        fishingRod.transform.localRotation = Quaternion.Euler(rotationX + 30, 0, rotationY);
    }

	private void Reel()
	{
        float wh = InputSystem.ReelGetAxis(ref lastAngle, ref  wasActive);
        // 巻く速度を調整
        wh *= reelSpeed[rod.GetFishSize()];

        if (wh < 0)
        {
            rodFloat.transform.position += (rodFloat.transform.position - transform.position).normalized * wh;
        }
    }

	public void FishingEnd(bool isSuccess, FishDataEntity fish)
	{
		// 釣り成功
		if (isSuccess)
		{
			Debug.Log(fish.fishName);
		}
		rodAnime.enabled = true;
		isHit = false;
		playerController.SetCamera(true);
		playerController.SetMove(true);
	}

	public void IsHit()
	{
		rodAnime.enabled = false;
		isHit = true;
		playerController.SetCamera(false);
		playerController.SetMove(false);
    }
}
